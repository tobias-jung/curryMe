var CustomElements = require('../customelements');
var http = require('http');
var url = require('url');

var JSON_TYPE = 'json';

CustomElements.register('web-resource', {
    outer: true,
    is: 'web-resource',
    attributes: {
        url: '',
        method: 'GET',
        headers: {},
        dataType: JSON_TYPE
    },
    prototype: {
        beforeRequest: function(data){
            var url = this.getAttribute('url');
            url = url.replace(/\$\{(.+?)\}/g, function($0, $1) {
                return $1 in data ? data[$1] : $0;
            });
            this.setAttribute('url', url);
        },
        request: function(resolve, reject){
            var options = url.parse(this.getAttribute('url'));
            options.method = this.getAttribute('method');
            options.headers = this.getAttribute('headers');
            var dataType = this.getAttribute('dataType');

            http.request(options, function(response) {
                var str = '';

                response.on('data', function (chunk) {
                    str += chunk;
                });

                response.on('end', function () {
                    var res;

                    if(dataType.toLowerCase() == JSON_TYPE){
                        res = JSON.parse(str)
                    }else{
                        res = str;
                    }

                    resolve(res);
                });

            }).end();

        }
    }
});

